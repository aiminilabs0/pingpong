<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pingpong Rubber Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            color-scheme: dark;
            --bg0: #060914;
            --bg1: #0b1022;
            --panel: rgba(255, 255, 255, 0.06);
            --panel-2: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.14);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.70);
            --shadow: rgba(0, 0, 0, 0.55);
            --focus: rgba(95, 207, 255, 0.55);
            --link: #7cd3ff;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
                "Segoe UI Emoji";
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: var(--text);
            background:
                radial-gradient(900px 500px at 18% 18%, rgba(233, 65, 145, 0.16), transparent 60%),
                radial-gradient(900px 500px at 82% 24%, rgba(211, 47, 47, 0.14), transparent 60%),
                radial-gradient(900px 500px at 55% 85%, rgba(124, 211, 255, 0.10), transparent 60%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
        }
        .chart-container {
            position: relative;
            height: 80vh;
            width: 80vw;
            background:
                linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            box-shadow:
                0 24px 70px var(--shadow),
                inset 0 1px 0 rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }
        .tabs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .tab {
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            border-radius: 999px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            user-select: none;
            transition: background-color 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
        }
        .tab:hover {
            background: rgba(255, 255, 255, 0.10);
            border-color: rgba(255, 255, 255, 0.22);
        }
        .tab:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus);
        }
        .tab.active {
            background: rgba(255, 255, 255, 0.14);
            border-color: rgba(255, 255, 255, 0.26);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        .tab img {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }
        .canvas-wrap {
            position: relative;
            flex: 1;
            /* Important for flexbox: allow the chart area to shrink instead of overflowing
               (otherwise the bottom axis can get clipped when the container has overflow:hidden). */
            min-height: 0;
        }
        #rubberChart {
            display: block;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 14px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
        }
        .shape-legend {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: rgba(10, 14, 28, 0.72);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 12px;
            line-height: 1.25;
            color: var(--text);
            box-shadow: 0 14px 35px rgba(0,0,0,0.45);
            pointer-events: none; /* don't block chart hover/click */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .shape-legend .row {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .shape-legend .row + .row {
            margin-top: 6px;
        }
        .shape-legend .marker {
            display: inline-block;
            width: 12px;
            height: 12px;
            flex: 0 0 12px;
        }
        .shape-legend .marker.rect {
            background: #2e7d32;
            border-radius: 2px;
        }
        .shape-legend .marker.circle {
            background: #6a1b9a;
            border-radius: 999px;
        }
        .chart-tooltip {
            position: absolute;
            z-index: 5;
            max-width: 320px;
            background: rgba(10, 14, 28, 0.90);
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text);
            font-size: 12px;
            line-height: 1.3;
            box-shadow: 0 18px 45px rgba(0,0,0,0.55);
            pointer-events: auto; /* allow clicking links */
            display: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .chart-tooltip .t {
            font-weight: 700;
            margin-bottom: 6px;
        }
        .chart-tooltip .row + .row {
            margin-top: 4px;
        }
        .chart-tooltip .links {
            margin-top: 8px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .chart-tooltip a {
            color: var(--link);
            text-decoration: none;
        }
        .chart-tooltip a:hover {
            text-decoration: underline;
        }
        .chart-tooltip .icon-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        .chart-tooltip .icon-link img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            display: block;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.55));
        }
    </style>
</head>
<body>

<div class="chart-container">
    <div class="tabs" role="tablist" aria-label="Brand">
        <button class="tab active" type="button" role="tab" aria-selected="true" data-brand="Butterfly">
            <img src="images/butterfly.ico" alt="" aria-hidden="true" />
            Butterfly
        </button>
        <button class="tab" type="button" role="tab" aria-selected="false" data-brand="Tibhar">
            <img src="images/tibhar.png" alt="" aria-hidden="true" />
            Tibhar
        </button>
    </div>
    <div class="canvas-wrap">
        <canvas id="rubberChart"></canvas>
        <div class="shape-legend" aria-hidden="true">
            <div class="row">
                <span class="marker rect"></span>
                <span>Pimples-in</span>
            </div>
            <div class="row">
                <span class="marker circle"></span>
                <span>Hybrid</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. Consolidated Data ---
    // We store color and shape directly with the data point to keep the visual distinction
    // while using only one dataset.

    // Brand-specific knobs (easy to replace later)
    const BUTTERFLY = 'Butterfly';
    const BUTTERFLY_COLOR = '#e84191';
    const BUTTERFLY_ICON = 'images/butterfly.ico';

    const TIBHAR = 'Tibhar';
    const TIBHAR_COLOR = '#d32f2f';
    const TIBHAR_ICON = 'images/tibhar.png';

    // Axis ranges per brand (used by the tabs).
    // Tune these numbers if you want a tighter/looser zoom per brand.
    const BRAND_AXIS_RANGES = {
        // Butterfly includes everything from classic control rubbers to modern high-tension.
        [BUTTERFLY]: { xMin: 50,   xMax: 105, yMin: 55,   yMax: 95 },
        [TIBHAR]:    { xMin: 110, xMax: 135, yMin: 110, yMax: 135 },
    };

    // Shape legend colors (regardless of brand)
    const NORMAL_RUBBER_COLOR = '#2e7d32';   // green
    const PIMPLES_IN_COLOR = '#6a1b9a';      // purple
    function colorForShape(shape) {
        return shape === 'circle' ? PIMPLES_IN_COLOR : NORMAL_RUBBER_COLOR;
    }
    function normalizeUrl(u) {
        return typeof u === 'string' ? u.trim() : '';
    }
    
    // Each rubber can optionally include more info (fill what you know):
    // {
    //   x, y, label, shape,
    //   thickness: '1.9 / 2.1',
    //   strategy: 'OFF / OFF+',
    //   control: 85,
    //   weight: '45g',
    //   hardness: '47.5',
    //   player: 'Zhang Jike',
    //   youtubeUrl: 'https://www.youtube.com/watch?v=...',
    //   productUrl: 'https://...',
    //   // Back-compat: `url` is treated as productUrl
    // }
    const butterflyRubbers = [
        // Orange Squares (Tenergy)
        {
            x: 85,
            y: 86,
            label: 'Dignics 05',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 88,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 96,
            y: 79,
            label: 'Dignics 09C',
            color: BUTTERFLY_COLOR,
            shape: 'circle',
            url: '',
            arc: 96,
            hardness: '44',
            thickness: '2.1 / 1.9',
        },
        {
            x: 79,
            y: 90,
            label: 'Dignics 64',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 84,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 82,
            y: 88,
            label: 'Dignics 80',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 86,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 73,
            y: 81,
            label: 'Glayzer',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 82,
            hardness: '38',
            thickness: '2.1 / 1.9',
        },
        {
            x: 87,
            y: 75,
            label: 'Glayzer 09C',
            color: BUTTERFLY_COLOR,
            shape: 'circle',
            url: '',
            arc: 95,
            hardness: '42',
            thickness: '2.1 / 1.9',
        },
        {
            x: 70,
            y: 83,
            label: 'Rozena',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 75,
            hardness: '35',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 76,
            y: 83,
            label: 'Tenergy 05',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: 'https://www.coupang.com/vp/products/8414405864?itemId=24331707549&vendorItemId=92706240298&q=%ED%85%8C%EB%84%88%EC%A7%8005&searchId=d10be3d818557427&sourceType=search&itemsCount=36&searchRank=0&rank=0&traceId=mjxipwjc',
            arc: 79,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 96,
            y: 82,
            label: 'Tenergy 05 Hard',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 92,
            hardness: '43',
            thickness: '2.1 / 1.9',
        },
        {
            x: 64,
            y: 81,
            label: 'Tenergy 05 FX',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 65,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 75,
            y: 84,
            label: 'Tenergy 19',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 78,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 76,
            y: 64,
            label: 'Tenergy 25',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 86,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 64,
            y: 62,
            label: 'Tenergy 25 FX',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 72,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 70,
            y: 87,
            label: 'Tenergy 64',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 75,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 58,
            y: 85,
            label: 'Tenergy 64 FX',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 61,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 73,
            y: 85,
            label: 'Tenergy 80',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 77,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 61,
            y: 83,
            label: 'Tenergy 80 FX',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 63,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 100,
            y: 88,
            label: 'Zyre 03',
            color: BUTTERFLY_COLOR,
            shape: 'rect',
            url: '',
            arc: 96,
            hardness: '44',
            thickness: '2.7 / 2.5',
        },
    ];

    // Add Tibhar rubbers here (same format as Butterfly).
    // Example:
    const tibharRubbers = [
        // NOTE: input format provided as "Speed (y) then Spin (x)"
        {
            x: 120,
            y: 124,
            label: 'EL-D',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.9 / 2.1',
            strategy: 'OFF- / OFF+',
            control: 83,
            hardness: '45',
        },
        {
            x: 117,
            y: 121,
            label: 'EL-P',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF+',
            control: 83,
            hardness: '42.5',
        },
        {
            x: 120,
            y: 123,
            label: 'EL-S',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1,7 / 1,9 / 2,1',
            strategy: 'OFF- / OFF+',
            control: 85,
            hardness: '45',
        },
        {
            x: 118,
            y: 120,
            label: 'FX-D',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 87,
            hardness: '45',
        },
        {
            x: 115,
            y: 120,
            label: 'FX-P',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.7 / 1.9 / 2.1',
            strategy: 'ALL / OFF',
            control: 90,
            hardness: '40',
        },
        {
            x: 117,
            y: 118,
            label: 'FX-S',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 87,
            hardness: '42.5',
        },
        {
            x: 122,
            y: 130,
            label: 'MX-D',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=haxt_8BOEoo',
            thickness: '1,9 / 2,1',
            strategy: 'OFF / OFF+',
            control: 75,
            hardness: '52',
        },
        {
            x: 122,
            y: 125,
            label: 'MX-P',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'OFF- / OFF+',
            control: 80,
            hardness: '47.5',
        },
        {
            x: 120,
            y: 128,
            label: 'MX-P 50',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '2.1',
            strategy: 'OFF / OFF+',
            control: 75,
            hardness: '50',
        },
        {
            x: 124,
            y: 125,
            label: 'MX-S',
            color: TIBHAR_COLOR,
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 80,
            hardness: '47.5',
        },
        {
            x: 130,
            y: 118,
            label: 'K3',
            color: TIBHAR_COLOR,
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 100,
            hardness: '53',
        },
        {
            x: 130,
            y: 115,
            label: 'K3 FX',
            color: TIBHAR_COLOR,
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF',
            control: 105,
            hardness: '48',
        },
        {
            x: 130,
            y: 125,
            label: 'K3 Pro',
            color: TIBHAR_COLOR,
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 95,
            hardness: '55',
        },
        {
            x: 120,
            y: 124,
            label: 'MK',
            color: TIBHAR_COLOR,
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF',
            control: 96,
            hardness: '48',
        },
        {
            x: 118,
            y: 118,
            label: 'MK FX',
            color: TIBHAR_COLOR,
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF-',
            control: 104,
            hardness: '44',
        },
        {
            x: 124,
            y: 130,
            label: 'MK Pro',
            color: TIBHAR_COLOR,
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 90,
            hardness: '51',
        },
    ];

    // --- 2. Chart Setup ---
    const ctx = document.getElementById('rubberChart').getContext('2d');

    const butterflyDataset = {
        label: BUTTERFLY, // Single Category Name
        data: butterflyRubbers,
        // Map the styles from the data array
        pointBackgroundColor: butterflyRubbers.map(d => colorForShape(d.shape)),
        pointBorderColor: butterflyRubbers.map(d => colorForShape(d.shape)),
        pointStyle: butterflyRubbers.map(d => d.shape),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const tibharDataset = {
        label: TIBHAR,
        data: tibharRubbers,
        pointBackgroundColor: tibharRubbers.map(d => colorForShape(d.shape ?? 'circle')),
        pointBorderColor: tibharRubbers.map(d => colorForShape(d.shape ?? 'circle')),
        pointStyle: tibharRubbers.map(d => d.shape ?? 'circle'),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                butterflyDataset,
                tibharDataset
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                // Extra bottom padding prevents the x-axis title from getting clipped.
                padding: { top: 20, right: 50, bottom: 56, left: 20 }
            },
            scales: {
                x: {
                    display: true,
                    min: 40,
                    max: 100,
                    ticks: {
                        display: true,
                        color: 'rgba(255,255,255,0.55)',
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: 'Spin',
                        font: { size: 16, weight: 'normal' },
                        color: 'rgba(255,255,255,0.88)',
                        padding: { top: 10 }
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.10)',
                        lineWidth: 1
                    }
                },
                y: {
                    display: true,
                    min: 40,
                    max: 100,
                    ticks: {
                        display: true,
                        color: 'rgba(255,255,255,0.55)',
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: 'Speed',
                        font: { size: 16, weight: 'normal' },
                        color: 'rgba(255,255,255,0.88)'
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.10)',
                        lineWidth: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        externalTooltipHandler(context);
                    }
                },
                datalabels: {
                    align: function(context) {
                        const val = context.dataset.data[context.dataIndex];
                        return val.x > 80 ? 'left' : 'right';
                    },
                    anchor: 'center',
                    offset: 10,
                    color: 'rgba(255,255,255,0.88)',
                    font: { size: 11, weight: 'normal' },
                    formatter: function(value) {
                        return value.label;
                    }
                }
            },
            // --- 3. Click Event Handler ---
            onClick: (evt, activeElements, chart) => {
                if (activeElements.length > 0) {
                    const datasetIndex = activeElements[0].datasetIndex;
                    const dataIndex = activeElements[0].index;
                    const ds = chart.data.datasets[datasetIndex];
                    const pointData = ds.data[dataIndex];

                    // Click opens a link if present (shopping preferred, then YouTube).
                    const product = normalizeUrl(pointData.productUrl) || normalizeUrl(pointData.url);
                    const youtube = normalizeUrl(pointData.youtubeUrl);
                    const toOpen = product || youtube;
                    if (toOpen) window.open(toOpen, '_blank');
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // --- HTML tooltip (clickable links) ---
    const canvasWrapEl = document.querySelector('.canvas-wrap');
    const tooltipEl = document.createElement('div');
    tooltipEl.className = 'chart-tooltip';
    canvasWrapEl.appendChild(tooltipEl);

    let tooltipPinned = false;
    let hideTooltipTimer = null;
    tooltipEl.addEventListener('mouseenter', () => {
        tooltipPinned = true;
        if (hideTooltipTimer) {
            window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = null;
        }
    });
    tooltipEl.addEventListener('mouseleave', () => {
        tooltipPinned = false;
        if (hideTooltipTimer) window.clearTimeout(hideTooltipTimer);
        hideTooltipTimer = window.setTimeout(() => {
            tooltipEl.style.display = 'none';
        }, 50);
    });

    function clearEl(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
    }

    function makeLink(label, url) {
        const u = normalizeUrl(url);
        if (!u) return null;
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = label;
        return a;
    }

    function makeIconLink(iconSrc, altText, url) {
        const u = normalizeUrl(url);
        if (!u) return null;
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'icon-link';
        a.setAttribute('aria-label', altText);
        const img = document.createElement('img');
        img.src = iconSrc;
        img.alt = altText;
        a.appendChild(img);
        return a;
    }

    function externalTooltipHandler(context) {
        const { chart, tooltip } = context;

        // If the tooltip should be hidden, only hide if the user isn't hovering the tooltip itself.
        if (tooltip.opacity === 0) {
            if (tooltipPinned) return;

            // Give the user a small window to move from the point to the tooltip to click links.
            if (hideTooltipTimer) window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = window.setTimeout(() => {
                if (!tooltipPinned) tooltipEl.style.display = 'none';
            }, 350);
            return;
        }

        if (hideTooltipTimer) {
            window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = null;
        }

        // Populate content from the hovered point.
        const dp = tooltip?.dataPoints?.[0];
        const r = dp?.raw ?? {};
        const brand = dp?.dataset?.label ? `${dp.dataset.label}: ` : '';

        clearEl(tooltipEl);

        const title = document.createElement('div');
        title.className = 't';
        title.textContent = `${brand}${r.label ?? ''}`;
        tooltipEl.appendChild(title);

        const rows = [];
        rows.push(`Spin: ${r.x}, Speed: ${r.y}`);
        if (r.type) rows.push(`Type: ${r.type}`);
        if (typeof r.arc === 'number') rows.push(`Arc: ${r.arc}`);
        if (r.thickness) rows.push(`Thickness: ${r.thickness}`);
        if (Array.isArray(r.sheetColors) && r.sheetColors.length > 0) rows.push(`Sheet colors: ${r.sheetColors.join(' / ')}`);
        if (r.strategy) rows.push(`Strategy: ${r.strategy}`);
        if (typeof r.control === 'number') rows.push(`Control: ${r.control}`);
        if (r.weight) rows.push(`Weight: ${r.weight}`);
        if (r.hardness) rows.push(`Hardness: ${r.hardness}`);
        if (r.player) rows.push(`Player: ${r.player}`);

        rows.forEach((txt) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.textContent = txt;
            tooltipEl.appendChild(row);
        });

        const links = document.createElement('div');
        links.className = 'links';
        const product = normalizeUrl(r.productUrl) || normalizeUrl(r.url);
        const youtube = normalizeUrl(r.youtubeUrl);
        const aShop = makeIconLink('images/sale.png', 'Sale', product);
        const aYt = makeIconLink('images/youtube.ico', 'YouTube', youtube);
        if (aShop) links.appendChild(aShop);
        if (aYt) links.appendChild(aYt);
        if (links.childNodes.length > 0) tooltipEl.appendChild(links);

        // Position near the cursor (within canvas-wrap, which is positioned).
        const wrapRect = canvasWrapEl.getBoundingClientRect();
        const left = Math.min(
            tooltip.caretX + 12,
            wrapRect.width - 12
        );
        const top = Math.min(
            tooltip.caretY + 12,
            wrapRect.height - 12
        );
        tooltipEl.style.left = `${left}px`;
        tooltipEl.style.top = `${top}px`;
        tooltipEl.style.display = 'block';
    }

    function setActiveBrand(brand) {
        // Ensure exactly one brand is visible.
        chart.setDatasetVisibility(0, brand === BUTTERFLY);
        chart.setDatasetVisibility(1, brand === TIBHAR);

        // Apply brand-specific axis ranges.
        const r = BRAND_AXIS_RANGES[brand];
        if (r) {
            chart.options.scales.x.min = r.xMin;
            chart.options.scales.x.max = r.xMax;
            chart.options.scales.y.min = r.yMin;
            chart.options.scales.y.max = r.yMax;
        }

        chart.update();

        // Update tab UI.
        const tabs = document.querySelectorAll('.tab[data-brand]');
        tabs.forEach((btn) => {
            const isActive = btn.getAttribute('data-brand') === brand;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
    }

    // Default to Butterfly.
    setActiveBrand(BUTTERFLY);

    // Tab click handlers.
    document.querySelectorAll('.tab[data-brand]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const brand = btn.getAttribute('data-brand');
            if (brand === BUTTERFLY || brand === TIBHAR) setActiveBrand(brand);
        });
    });

</script>

</body>
</html> 