<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pingpong Rubber Chart</title>
    <link rel="stylesheet" href="main.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>

<div class="lang-switch" aria-label="Language">
    <span class="select-wrap">
        <select id="langSelect" aria-label="Language">
            <option value="ko">ðŸ‡°ðŸ‡· Korea</option>
            <option value="en">ðŸ‡ºðŸ‡¸ USA</option>
        </select>
    </span>
</div>

<div class="chart-container">
    <div class="tabs" role="tablist" aria-label="Brand" id="brandTabs">
        <button class="tab active" type="button" role="tab" aria-selected="true" data-brand="Butterfly">
            <img src="images/butterfly.ico" alt="" aria-hidden="true" />
            <span data-i18n="brandButterfly">Butterfly</span>
        </button>
        <button class="tab" type="button" role="tab" aria-selected="false" data-brand="Tibhar">
            <img src="images/tibhar.png" alt="" aria-hidden="true" />
            <span data-i18n="brandTibhar">Tibhar</span>
        </button>
        <button class="tab" type="button" role="tab" aria-selected="false" data-brand="XIOM">
            <img src="images/xiom.png" alt="" aria-hidden="true" />
            <span data-i18n="brandXiom">XIOM</span>
        </button>
    </div>
    <div class="canvas-wrap">
        <canvas id="rubberChart"></canvas>
        <div class="hardness-legend" aria-hidden="true">
            <div class="content">
                <div class="row">
                    <span class="bar" data-i18n="legendHardness">Hardness</span>
                </div>
                <div class="example">
                    <div class="ex-line">
                        <span class="country flag" title="Germany">ðŸ‡©ðŸ‡ª</span>
                        <div class="nums">
                            <span class="n left">40</span>
                            <span class="n mid">47.5</span>
                            <span class="n right">55</span>
                        </div>
                    </div>
                    <div class="ex-line">
                        <span class="country flag" title="Japan">ðŸ‡¯ðŸ‡µ</span>
                        <div class="nums">
                            <span class="n left">33</span>
                            <span class="n mid">36</span>
                            <span class="n right">44</span>
                        </div>
                    </div>
                    <div class="ex-line">
                        <span class="country flag" title="China">ðŸ‡¨ðŸ‡³</span>
                        <div class="nums">
                            <span class="n left">35</span>
                            <span class="n mid">39</span>
                            <span class="n right">41</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="shape-legend" aria-hidden="true">
            <div class="row">
                <span class="marker circle"></span>
                <span data-i18n="legendPimplesIn">Pimples-in</span>
            </div>
            <div class="row">
                <span class="marker rectRot"></span>
                <span data-i18n="legendHybrid">Hybrid</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- i18n (EN/KR) ---
    const I18N = {
        en: {
            pageTitle: 'Pingpong Rubber Chart',
            ariaBrandTabs: 'Brand',
            brandButterfly: 'Butterfly',
            brandTibhar: 'Tibhar',
            brandXiom: 'XIOM',
            legendHardness: 'Hardness',
            legendPimplesIn: 'Pimples-in',
            legendHybrid: 'Hybrid',
            axisSpin: 'Spin',
            axisSpeed: 'Speed',
            tooltipSpinSpeed: 'Spin: {spin}, Speed: {speed}',
            tooltipType: 'Type',
            tooltipArc: 'Arc',
            tooltipThickness: 'Thickness',
            tooltipSheetColors: 'Sheet colors',
            tooltipStrategy: 'Strategy',
            tooltipControl: 'Control',
            tooltipWeight: 'Weight',
            tooltipHardness: 'Hardness',
            tooltipPlayer: 'Player',
            iconSale: 'Sale',
            iconYouTube: 'YouTube'
        },
        ko: {
            pageTitle: 'íƒêµ¬ ëŸ¬ë²„ ì°¨íŠ¸',
            ariaBrandTabs: 'ë¸Œëžœë“œ',
            brandButterfly: 'ë²„í„°í”Œë¼ì´',
            brandTibhar: 'í‹°ë°”',
            brandXiom: 'ì—‘ì‹œì˜´',
            legendHardness: 'ê²½ë„',
            legendPimplesIn: 'í‰ë©´ëŸ¬ë²„',
            legendHybrid: 'í•˜ì´ë¸Œë¦¬ë“œ',
            axisSpin: 'íšŒì „',
            axisSpeed: 'ìŠ¤í”¼ë“œ',
            tooltipSpinSpeed: 'íšŒì „: {spin}, ìŠ¤í”¼ë“œ: {speed}',
            tooltipType: 'íƒ€ìž…',
            tooltipArc: 'ê¶¤ë„',
            tooltipThickness: 'ë‘ê»˜',
            tooltipSheetColors: 'ì‹œíŠ¸ ìƒ‰ìƒ',
            tooltipStrategy: 'ìŠ¤íƒ€ì¼',
            tooltipControl: 'ì»¨íŠ¸ë¡¤',
            tooltipWeight: 'ë¬´ê²Œ',
            tooltipHardness: 'ê²½ë„',
            tooltipPlayer: 'ì„ ìˆ˜',
            iconSale: 'êµ¬ë§¤',
            iconYouTube: 'ìœ íŠœë¸Œ'
        }
    };

    function detectDefaultLang() {
        const nav = (navigator.language || '').toLowerCase();
        return nav.startsWith('ko') ? 'ko' : 'en';
    }

    let currentLang = window.localStorage.getItem('lang') || detectDefaultLang();
    if (!I18N[currentLang]) currentLang = 'en';

    function t(key, vars) {
        const table = I18N[currentLang] || I18N.en;
        let s = table[key] ?? I18N.en[key] ?? key;
        if (vars && typeof s === 'string') {
            for (const [k, v] of Object.entries(vars)) {
                s = s.replaceAll(`{${k}}`, String(v));
            }
        }
        return s;
    }

    function localizeBrandName(brand) {
        if (brand === 'Butterfly') return t('brandButterfly');
        if (brand === 'Tibhar') return t('brandTibhar');
        if (brand === 'XIOM') return t('brandXiom');
        return brand;
    }

    // Rubber name localization (used by point labels + tooltip title)
    const RUBBER_NAME_KO = {
        'Dignics 05': 'ë””ê·¸ë‹‰ìŠ¤ 05',
        'Dignics 09C': 'ë””ê·¸ë‹‰ìŠ¤ 09C',
        'Dignics 64': 'ë””ê·¸ë‹‰ìŠ¤ 64',
        'Dignics 80': 'ë””ê·¸ë‹‰ìŠ¤ 80',
        'Glayzer': 'ê¸€ë ˆì´ì €',
        'Glayzer 09C': 'ê¸€ë ˆì´ì € 09C',
        'Rozena': 'ë¡œì œë‚˜',
        'Tenergy 05': 'í…Œë„ˆì§€ 05',
        'Tenergy 05 Hard': 'í…Œë„ˆì§€ 05í•˜ë“œ',
        'Tenergy 05 FX': 'í…Œë„ˆì§€ 05FX',
        'Tenergy 19': 'í…Œë„ˆì§€ 19',
        'Tenergy 25': 'í…Œë„ˆì§€ 25',
        'Tenergy 25 FX': 'í…Œë„ˆì§€ 25FX',
        'Tenergy 64': 'í…Œë„ˆì§€ 64',
        'Tenergy 64 FX': 'í…Œë„ˆì§€ 64FX',
        'Tenergy 80': 'í…Œë„ˆì§€ 80',
        'Tenergy 80 FX': 'í…Œë„ˆì§€ 80FX',
        'Zyre 03': 'ìžì´ì–´ 03',

        // Tibhar (Evolution / Hybrid)
        'EL-D': 'EL-D',
        'EL-P': 'EL-P',
        'EL-S': 'EL-S',
        'FX-D': 'FX-D',
        'FX-P': 'FX-P',
        'FX-S': 'FX-S',
        'MX-D': 'MX-D',
        'MX-P': 'MX-P',
        'MX-P 50': 'MX-P 50',
        'MX-S': 'MX-S',
        'K3': 'K3',
        'K3 FX': 'K3 FX',
        'K3 Pro': 'K3 Pro',
        'MK': 'MK',
        'MK FX': 'MK FX',
        'MK Pro': 'MK Pro',

        // XIOM
        'C52.5': 'C52.5',
        'C55': 'C55',
        'C57.5': 'C57.5',
        'V47.5': 'V47.5',
        'Z52.5': 'Z52.5',
        'X47.5': 'X47.5',
        'H52.5': 'H52.5',

        'Sigma 5': 'ì‹œê·¸ë§ˆ 5',
        'Tau 3': 'íƒ€ìš° 3',
        'Omega 7Pro': 'ì˜¤ë©”ê°€7 í”„ë¡œ',
        'China Guang': 'ì°¨ì´ë‚˜ê´‘',

        // Vega series
        'Vega Pro': 'ë² ê°€ í”„ë¡œ',
        'Vega Asia': 'ë² ê°€ ì•„ì‹œì•„',
        'Vega Europe': 'ë² ê°€ ìœ ëŸ½',
    };

    function localizeRubberName(name) {
        const s = typeof name === 'string' ? name : '';
        if (!s) return '';
        if (currentLang !== 'ko') return s;
        return RUBBER_NAME_KO[s] ?? s;
    }

    function applyLanguageToDom() {
        document.documentElement.lang = currentLang;
        document.title = t('pageTitle');

        const brandTabs = document.getElementById('brandTabs');
        if (brandTabs) brandTabs.setAttribute('aria-label', t('ariaBrandTabs'));

        document.querySelectorAll('[data-i18n]').forEach((el) => {
            const key = el.getAttribute('data-i18n');
            if (!key) return;
            el.textContent = t(key);
        });
        const select = document.getElementById('langSelect');
        if (select && select.value !== currentLang) select.value = currentLang;
    }

    function applyLanguageToChart(chart) {
        if (!chart?.options?.scales) return;
        if (chart.options.scales.x?.title) chart.options.scales.x.title.text = t('axisSpin');
        if (chart.options.scales.y?.title) chart.options.scales.y.title.text = t('axisSpeed');
        chart.update();
    }

    function setLang(lang, chart, tooltipEl) {
        if (!I18N[lang]) return;
        currentLang = lang;
        window.localStorage.setItem('lang', currentLang);
        applyLanguageToDom();
        applyLanguageToChart(chart);
        if (tooltipEl) tooltipEl.style.display = 'none';
    }

    // --- 1. Consolidated Data ---
    // We store color and shape directly with the data point to keep the visual distinction
    // while using only one dataset.

    // Brand-specific knobs (easy to replace later)
    const BUTTERFLY = 'Butterfly';
    const BUTTERFLY_ICON = 'images/butterfly.ico';

    const TIBHAR = 'Tibhar';
    const TIBHAR_ICON = 'images/tibhar.png';

    const XIOM = 'XIOM';
    const XIOM_ICON = 'images/xiom.png';

    // Axis ranges per brand (used by the tabs).
    // Tune these numbers if you want a tighter/looser zoom per brand.
    const BRAND_AXIS_RANGES = {
        // Butterfly includes everything from classic control rubbers to modern high-tension.
        [BUTTERFLY]: { xMin: 55,  xMax: 105, yMin: 60,  yMax: 95 },
        [TIBHAR]:    { xMin: 110, xMax: 135, yMin: 110, yMax: 135 },
        [XIOM]:      { xMin: 30,  xMax: 90, yMin: 40,  yMax: 80 },
    };

    // Normal Rubber (Orange) - shade by hardness (higher hardness => darker)
    const NORMAL_RUBBER_ULTRA_LIGHT = '#FFE0B2'; // Very light orange / pastel
    const NORMAL_RUBBER_VERY_LIGHT  = '#FFCC80'; // Lighter than LIGHT
    const NORMAL_RUBBER_LIGHT       = '#FFB74D'; // Light
    const NORMAL_RUBBER_COLOR       = '#FF9100'; // Normal
    const NORMAL_RUBBER_DARK        = '#EF6C00'; // Dark

    const NORMAL_RUBBER_SHADES = [
        NORMAL_RUBBER_ULTRA_LIGHT,
        NORMAL_RUBBER_VERY_LIGHT,
        NORMAL_RUBBER_LIGHT,
        NORMAL_RUBBER_COLOR,
        NORMAL_RUBBER_DARK
    ];

    // Company-specific hardness ranges (tweak these as you add more brands).
    // If a brand is missing here, we fall back to min/max computed from the brand's dataset.
    const BRAND_HARDNESS_RANGES = {
        [BUTTERFLY]: { min: 32, max: 44 },
        [TIBHAR]:    { min: 40, max: 55 },
        [XIOM]:      { min: 40, max: 55 },
    };

    function parseHardness(h) {
        if (typeof h === 'number' && Number.isFinite(h)) return h;
        if (typeof h === 'string') {
            const n = Number.parseFloat(h.trim());
            return Number.isFinite(n) ? n : null;
        }
        return null;
    }

    function computeHardnessRange(data) {
        let min = Infinity;
        let max = -Infinity;
        for (const d of data) {
            const h = parseHardness(d?.hardness);
            if (h == null) continue;
            if (h < min) min = h;
            if (h > max) max = h;
        }
        if (!Number.isFinite(min) || !Number.isFinite(max)) return null;
        return { min, max };
    }

    function clamp01(t) {
        if (t < 0) return 0;
        if (t > 1) return 1;
        return t;
    }

    function shadeFromHardness(h, range) {
        if (h == null || !range) return NORMAL_RUBBER_COLOR;
        const denom = (range.max - range.min);
        const t = denom === 0 ? 0.5 : clamp01((h - range.min) / denom);
        const idx = Math.round(t * (NORMAL_RUBBER_SHADES.length - 1));
        return NORMAL_RUBBER_SHADES[idx] ?? NORMAL_RUBBER_COLOR;
    }

    function colorForRubberPoint(d, brand, brandData) {
        const h = parseHardness(d?.hardness);
        const range = BRAND_HARDNESS_RANGES[brand] ?? computeHardnessRange(brandData);
        return shadeFromHardness(h, range);
    }
    function normalizeUrl(u) {
        return typeof u === 'string' ? u.trim() : '';
    }

    // Swap shapes:
    // - circle -> rectRot
    // - rect   -> circle
    function mapPointStyle(shape) {
        if (shape === 'hybrid') return 'rectRot';
        if (shape === 'normal') return 'circle';
        return shape ?? 'normal';
    }
    
    const butterflyRubbers = [
        // Orange Squares (Tenergy)
        {
            x: 85,
            y: 86,
            label: 'Dignics 05',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 88,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 96,
            y: 79,
            label: 'Dignics 09C',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            arc: 96,
            hardness: '44',
            thickness: '2.1 / 1.9',
        },
        {
            x: 79,
            y: 90,
            label: 'Dignics 64',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 84,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 82,
            y: 88,
            label: 'Dignics 80',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 86,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 73,
            y: 81,
            label: 'Glayzer',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 82,
            hardness: '38',
            thickness: '2.1 / 1.9',
        },
        {
            x: 87,
            y: 75,
            label: 'Glayzer 09C',
            shape: 'circle',
            productUrl: '',
            youtubeUrl: '',
            arc: 95,
            hardness: '42',
            thickness: '2.1 / 1.9',
        },
        {
            x: 70,
            y: 83,
            label: 'Rozena',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 75,
            hardness: '35',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 76,
            y: 83,
            label: 'Tenergy 05',
            shape: 'normal',
            productUrl: 'https://www.coupang.com/vp/products/8414405864?itemId=24331707549&vendorItemId=92706240298&q=%ED%85%8C%EB%84%88%EC%A7%8005&searchId=d10be3d818557427&sourceType=search&itemsCount=36&searchRank=0&rank=0&traceId=mjxipwjc',
            youtubeUrl: '',
            arc: 79,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 96,
            y: 82,
            label: 'Tenergy 05 Hard',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 92,
            hardness: '43',
            thickness: '2.1 / 1.9',
        },
        {
            x: 64,
            y: 81,
            label: 'Tenergy 05 FX',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 65,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 75,
            y: 84,
            label: 'Tenergy 19',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 78,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 76,
            y: 64,
            label: 'Tenergy 25',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 86,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 64,
            y: 62,
            label: 'Tenergy 25 FX',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 72,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 70,
            y: 87,
            label: 'Tenergy 64',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 75,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 58,
            y: 85,
            label: 'Tenergy 64 FX',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 61,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 73,
            y: 85,
            label: 'Tenergy 80',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 77,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 61,
            y: 83,
            label: 'Tenergy 80 FX',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            arc: 63,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 100,
            y: 88,
            label: 'Zyre 03',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=_U0m4EtsgZk',
            arc: 96,
            hardness: '44',
            thickness: '2.7 / 2.5',
        },
    ];

    const tibharRubbers = [
        // NOTE: input format provided as "Speed (y) then Spin (x)"
        {
            x: 120,
            y: 125,
            label: 'EL-D',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.9 / 2.1',
            strategy: 'OFF- / OFF+',
            control: 83,
            hardness: '45',
        },
        {
            x: 117,
            y: 121,
            label: 'EL-P',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF+',
            control: 83,
            hardness: '42.5',
        },
        {
            x: 120,
            y: 123,
            label: 'EL-S',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.5 / 1,7 / 1,9 / 2,1',
            strategy: 'OFF- / OFF+',
            control: 85,
            hardness: '45',
        },
        {
            x: 118,
            y: 120,
            label: 'FX-D',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 87,
            hardness: '45',
        },
        {
            x: 115,
            y: 120,
            label: 'FX-P',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.7 / 1.9 / 2.1',
            strategy: 'ALL / OFF',
            control: 90,
            hardness: '40',
        },
        {
            x: 117,
            y: 118,
            label: 'FX-S',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 87,
            hardness: '42.5',
        },
        {
            x: 122,
            y: 130,
            label: 'MX-D',
            shape: 'normal',
            productUrl: 'https://smartstore.naver.com/doublesports/products/5540481632',
            youtubeUrl: 'https://www.youtube.com/watch?v=haxt_8BOEoo',
            thickness: '1,9 / 2,1',
            strategy: 'OFF / OFF+',
            control: 75,
            hardness: '52',
        },
        {
            x: 122,
            y: 125,
            label: 'MX-P',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=63MWAt7NNfo',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'OFF- / OFF+',
            control: 80,
            hardness: '47.5',
        },
        {
            x: 120,
            y: 128,
            label: 'MX-P 50',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=JVpgPpSdtcg',
            thickness: '2.1',
            strategy: 'OFF / OFF+',
            control: 75,
            hardness: '50',
        },
        {
            x: 124,
            y: 125,
            label: 'MX-S',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 80,
            hardness: '47.5',
        },
        {
            x: 130,
            y: 118,
            label: 'K3',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=uY9VcVM2lnE&pp=ygUJ7Yuw67CUIGsz',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 100,
            hardness: '53',
        },
        {
            x: 130,
            y: 115,
            label: 'K3 FX',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF',
            control: 105,
            hardness: '48',
        },
        {
            x: 130,
            y: 125,
            label: 'K3 Pro',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 95,
            hardness: '55',
        },
        {
            x: 120,
            y: 124,
            label: 'MK',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF',
            control: 96,
            hardness: '48',
        },
        {
            x: 118,
            y: 118,
            label: 'MK FX',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF-',
            control: 104,
            hardness: '44',
        },
        {
            x: 124,
            y: 130,
            label: 'MK Pro',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 90,
            hardness: '51',
        },
    ];

    const xiomRubbers = [
        {
            x: 80,
            y: 60,
            label: 'C52.5',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            hardness: '52.5',
            weight: '52g',
        },
        {
            x: 80,
            y: 61,
            label: 'C55',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            hardness: '55',
            weight: '54g',
        },
        {
            x: 75,
            y: 70,
            label: 'C57.5',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            hardness: '57.5',
            weight: '56g',
        },

        {
            x: 54,
            y: 70,
            label: 'V47.5',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=7ZZFFb38RK0',
            hardness: '47.5',
            weight: '50g',
        },
        {
            x: 60,
            y: 50,
            label: 'Z52.5',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=iRWkjUaIZGI',
            hardness: '52.5',
            weight: '54g',
        },
        {
            x: 67,
            y: 60,
            label: 'X47.5',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=UryhwHLv4Ew',
            hardness: '47.5',
            weight: '51g',
        },
        {
            x: 70,
            y: 51,
            label: 'H52.5',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=rNfimIATn14',
            hardness: '52.5',
            weight: '52g',
        },

        {
            x: 54,
            y: 60,
            label: 'Sigma 5',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=m698fvIxQpY&t=620s',
            hardness: '47.5',
            weight: '46.9g',
        },

        {
            x: 50,
            y: 60,
            label: 'Vega Pro',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            hardness: '47.5',
            weight: '50g',
        },
        {
            x: 50,
            y: 50,
            label: 'Vega Asia',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            hardness: '47.5',
            weight: '50g',
        },
        {
            x: 34,
            y: 60,
            label: 'Vega Europe',
            shape: 'normal',
            productUrl: '',
            youtubeUrl: '',
            hardness: '42.5',
            weight: '50g',
        },

        {
            x: 87,
            y: 41,
            label: 'Tau 3',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            hardness: '57.5',
            weight: '48g',
        },
        {
            x: 64,
            y: 61,
            label: 'Omega 7Pro',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            hardness: '47.5',
            weight: '50g',
        },
        {
            x: 67,
            y: 50,
            label: 'China Guang',
            shape: 'hybrid',
            productUrl: '',
            youtubeUrl: '',
            hardness: '55',
            weight: '50g',
        },
    ];

    // --- 2. Chart Setup ---
    const ctx = document.getElementById('rubberChart').getContext('2d');

    // Keep the bottom-right "shape legend" aligned to the chart's *plot area* (chartArea),
    // not the full canvas (which includes extra right padding for labels).
    const overlayAlignPlugin = {
        id: 'overlayAlignPlugin',
        afterLayout(chart) {
            const wrap = chart?.canvas?.closest?.('.canvas-wrap');
            if (!wrap || !chart?.chartArea) return;

            const shapeLegend = wrap.querySelector('.shape-legend');
            if (!shapeLegend) return;

            const cs = getComputedStyle(shapeLegend);
            const padRight = parseFloat(cs.paddingRight) || 0;
            const insetRight = (chart.width - chart.chartArea.right) || 0;

            // We want the *text* to end at chartArea.right, which is inside the legend box by `paddingRight`.
            const right = Math.max(0, insetRight - padRight);
            shapeLegend.style.right = `${right}px`;
        }
    };

    const butterflyDataset = {
        label: BUTTERFLY, // Single Category Name
        data: butterflyRubbers,
        // Map the styles from the data array
        pointBackgroundColor: butterflyRubbers.map(d => colorForRubberPoint(d, BUTTERFLY, butterflyRubbers)),
        pointBorderColor: butterflyRubbers.map(d => colorForRubberPoint(d, BUTTERFLY, butterflyRubbers)),
        pointStyle: butterflyRubbers.map(d => mapPointStyle(d.shape)),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const tibharDataset = {
        label: TIBHAR,
        data: tibharRubbers,
        pointBackgroundColor: tibharRubbers.map(d => colorForRubberPoint(d, TIBHAR, tibharRubbers)),
        pointBorderColor: tibharRubbers.map(d => colorForRubberPoint(d, TIBHAR, tibharRubbers)),
        pointStyle: tibharRubbers.map(d => mapPointStyle(d.shape ?? 'normal')),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const xiomDataset = {
        label: XIOM,
        data: xiomRubbers,
        pointBackgroundColor: xiomRubbers.map(d => colorForRubberPoint(d, XIOM, xiomRubbers)),
        pointBorderColor: xiomRubbers.map(d => colorForRubberPoint(d, XIOM, xiomRubbers)),
        pointStyle: xiomRubbers.map(d => mapPointStyle(d.shape ?? 'normal')),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                butterflyDataset,
                tibharDataset,
                xiomDataset
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                // Extra bottom padding prevents the x-axis title from getting clipped.
                padding: { top: 20, right: 20, bottom: 56, left: 20 }
            },
            scales: {
                x: {
                    display: true,
                    min: 40,
                    max: 100,
                    ticks: {
                        display: true,
                        color: 'rgba(255,255,255,0.55)',
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: t('axisSpin'),
                        font: { size: 16, weight: 'normal' },
                        color: 'rgba(255,255,255,0.88)',
                        padding: { top: 10 }
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.10)',
                        lineWidth: 1
                    }
                },
                y: {
                    display: true,
                    min: 40,
                    max: 100,
                    ticks: {
                        display: true,
                        color: 'rgba(255,255,255,0.55)',
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: t('axisSpeed'),
                        font: { size: 16, weight: 'normal' },
                        color: 'rgba(255,255,255,0.88)'
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.10)',
                        lineWidth: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        externalTooltipHandler(context);
                    }
                },
                datalabels: {
                    // Always place the label immediately to the right of the point (dot).
                    align: 'right',
                    anchor: 'center',
                    offset: 8,
                    color: 'rgba(255,255,255,0.88)',
                    font: { size: 11, weight: 'normal' },
                    textAlign: 'left',
                    clamp: true,
                    formatter: function(value) {
                        return localizeRubberName(value.label);
                    }
                }
            },
            // --- 3. Click Event Handler ---
            onClick: (evt, activeElements, chart) => {
                if (activeElements.length > 0) {
                    const datasetIndex = activeElements[0].datasetIndex;
                    const dataIndex = activeElements[0].index;
                    const ds = chart.data.datasets[datasetIndex];
                    const pointData = ds.data[dataIndex];

                    const product = normalizeUrl(pointData.productUrl);
                    const youtube = normalizeUrl(pointData.youtubeUrl);
                    const toOpen = product || youtube;
                    if (toOpen) window.open(toOpen, '_blank');
                }
            }
        },
        plugins: [ChartDataLabels, overlayAlignPlugin]
    });

    // --- HTML tooltip (clickable links) ---
    const canvasWrapEl = document.querySelector('.canvas-wrap');
    const tooltipEl = document.createElement('div');
    tooltipEl.className = 'chart-tooltip';
    canvasWrapEl.appendChild(tooltipEl);

    let tooltipPinned = false;
    let hideTooltipTimer = null;
    tooltipEl.addEventListener('mouseenter', () => {
        tooltipPinned = true;
        if (hideTooltipTimer) {
            window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = null;
        }
    });
    tooltipEl.addEventListener('mouseleave', () => {
        tooltipPinned = false;
        if (hideTooltipTimer) window.clearTimeout(hideTooltipTimer);
        hideTooltipTimer = window.setTimeout(() => {
            tooltipEl.style.display = 'none';
        }, 50);
    });

    function clearEl(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
    }

    function makeLink(label, url) {
        const u = normalizeUrl(url);
        if (!u) return null;
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = label;
        return a;
    }

    function makeIconLink(iconSrc, altText, url) {
        const u = normalizeUrl(url);
        if (!u) return null;
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'icon-link';
        a.setAttribute('aria-label', altText);
        const img = document.createElement('img');
        img.src = iconSrc;
        img.alt = altText;
        a.appendChild(img);
        return a;
    }

    function externalTooltipHandler(context) {
        const { chart, tooltip } = context;

        // If the tooltip should be hidden, only hide if the user isn't hovering the tooltip itself.
        if (tooltip.opacity === 0) {
            if (tooltipPinned) return;

            // Give the user a small window to move from the point to the tooltip to click links.
            if (hideTooltipTimer) window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = window.setTimeout(() => {
                if (!tooltipPinned) tooltipEl.style.display = 'none';
            }, 350);
            return;
        }

        if (hideTooltipTimer) {
            window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = null;
        }

        // Populate content from the hovered point.
        const dp = tooltip?.dataPoints?.[0];
        const r = dp?.raw ?? {};
        clearEl(tooltipEl);

        const title = document.createElement('div');
        title.className = 't';
        title.textContent = `${localizeRubberName(r.label ?? '')}`;
        tooltipEl.appendChild(title);

        const rows = [];
        rows.push(t('tooltipSpinSpeed', { spin: r.x, speed: r.y }));
        if (r.type) rows.push(`${t('tooltipType')}: ${r.type}`);
        if (typeof r.arc === 'number') rows.push(`${t('tooltipArc')}: ${r.arc}`);
        if (r.thickness) rows.push(`${t('tooltipThickness')}: ${r.thickness}`);
        if (Array.isArray(r.sheetColors) && r.sheetColors.length > 0) rows.push(`${t('tooltipSheetColors')}: ${r.sheetColors.join(' / ')}`);
        if (r.strategy) rows.push(`${t('tooltipStrategy')}: ${r.strategy}`);
        if (typeof r.control === 'number') rows.push(`${t('tooltipControl')}: ${r.control}`);
        if (r.weight) rows.push(`${t('tooltipWeight')}: ${r.weight}`);
        if (r.hardness) rows.push(`${t('tooltipHardness')}: ${r.hardness}`);
        if (r.player) rows.push(`${t('tooltipPlayer')}: ${r.player}`);

        rows.forEach((txt) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.textContent = txt;
            tooltipEl.appendChild(row);
        });

        const links = document.createElement('div');
        links.className = 'links';
        const product = normalizeUrl(r.productUrl);
        const youtube = normalizeUrl(r.youtubeUrl);
        const aShop = makeIconLink('images/sale.png', t('iconSale'), product);
        const aYt = makeIconLink('images/youtube.ico', t('iconYouTube'), youtube);
        if (aShop) links.appendChild(aShop);
        if (aYt) links.appendChild(aYt);
        if (links.childNodes.length > 0) tooltipEl.appendChild(links);

        // Position near the cursor (within canvas-wrap, which is positioned).
        const wrapRect = canvasWrapEl.getBoundingClientRect();
        const left = Math.min(
            tooltip.caretX + 12,
            wrapRect.width - 12
        );
        const top = Math.min(
            tooltip.caretY + 12,
            wrapRect.height - 12
        );
        tooltipEl.style.left = `${left}px`;
        tooltipEl.style.top = `${top}px`;
        tooltipEl.style.display = 'block';
    }

    function setActiveBrand(brand) {
        // Ensure exactly one brand is visible.
        chart.setDatasetVisibility(0, brand === BUTTERFLY);
        chart.setDatasetVisibility(1, brand === TIBHAR);
        chart.setDatasetVisibility(2, brand === XIOM);

        // Apply brand-specific axis ranges.
        const r = BRAND_AXIS_RANGES[brand];
        if (r) {
            chart.options.scales.x.min = r.xMin;
            chart.options.scales.x.max = r.xMax;
            chart.options.scales.y.min = r.yMin;
            chart.options.scales.y.max = r.yMax;
        }

        chart.update();

        // Update tab UI.
        const tabs = document.querySelectorAll('.tab[data-brand]');
        tabs.forEach((btn) => {
            const isActive = btn.getAttribute('data-brand') === brand;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
    }

    // Default to Butterfly.
    setActiveBrand(BUTTERFLY);

    // Language switch init + handlers.
    applyLanguageToDom();
    applyLanguageToChart(chart);
    const langSelect = document.getElementById('langSelect');
    if (langSelect) {
        langSelect.addEventListener('change', () => {
            const lang = langSelect.value;
            if (!lang) return;
            setLang(lang, chart, tooltipEl);
        });
    }

    // Tab click handlers.
    document.querySelectorAll('.tab[data-brand]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const brand = btn.getAttribute('data-brand');
            if (brand && BRAND_AXIS_RANGES[brand]) setActiveBrand(brand);
        });
    });

</script>

</body>
</html> 