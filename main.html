<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pingpong Rubber Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .chart-container {
            position: relative;
            height: 80vh;
            width: 80vw;
            background-color: #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="chart-container">
    <canvas id="rubberChart"></canvas>
</div>

<script>
    // --- 1. Consolidated Data ---
    // We store color and shape directly with the data point to keep the visual distinction
    // while using only one dataset.

    // Brand-specific knobs (easy to replace later)
    const BUTTERFLY = 'Butterfly';
    const BUTTERFLY_COLOR = '#e84191';
    const BUTTERFLY_ICON = 'images/butterfly.ico';

    const TIBHAR = 'Tibhar';
    const TIBHAR_COLOR = '#d32f2f';
    const TIBHAR_ICON = 'images/tibhar.png';
    
    // Each rubber can optionally include a `url` for manual product links:
    // { x, y, label, color, shape, url: 'https://...' }
    const butterflyRubbers = [
        // Orange Squares (Tenergy)
        { x: 75, y: 84, label: 'Tenergy 19',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 70, y: 87, label: 'Tenergy 64',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 58, y: 85, label: 'Tenergy 64 FX',   color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 73, y: 85, label: 'Tenergy 80',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 61, y: 83, label: 'Tenergy 80 FX',   color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 76, y: 83, label: 'Tenergy 05',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 64, y: 81, label: 'Tenergy 05 FX',   color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 96, y: 82, label: 'Tenergy 05 Hard', color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 76, y: 64, label: 'Tenergy 25',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 64, y: 62, label: 'Tenergy 25 FX',   color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 70, y: 83, label: 'Rozena',          color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 79, y: 90, label: 'Dignics 64',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 82, y: 88, label: 'Dignics 80',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 85, y: 86, label: 'Dignics 05',      color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 96, y: 79, label: 'Dignics 09C',     color: BUTTERFLY_COLOR, shape: 'circle' },
        { x: 73, y: 81, label: 'Glayzer',         color: BUTTERFLY_COLOR, shape: 'rect' },
        { x: 87, y: 75, label: 'Glayzer 09C',     color: BUTTERFLY_COLOR, shape: 'circle' },
        { x: 100, y: 88, label: 'Zyre 03',        color: BUTTERFLY_COLOR, shape: 'rect' },
    ];

    // Add Tibhar rubbers here (same format as Butterfly).
    // Example:
    const tibharRubbers = [
        // NOTE: input format provided as "Speed (y) then Spin (x)"
        { x: 90, y: 93, label: 'EL-D',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 92, y: 91, label: 'EL-P',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 90, y: 87, label: 'EL-S',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 88, y: 87, label: 'FX-D',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 91, y: 86, label: 'FX-P',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 92, y: 87, label: 'FX-S',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 91, y: 93, label: 'MX-D',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 93, y: 95, label: 'MX-P',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 94, y: 93, label: 'MX-P 50',   color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 95, y: 92, label: 'MX-S',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 92, y: 87, label: 'K3',        color: TIBHAR_COLOR, shape: 'circle', url: '' },
        { x: 94, y: 89, label: 'K3 FX',     color: TIBHAR_COLOR, shape: 'circle', url: '' },
        { x: 93, y: 96, label: 'K3 Pro',    color: TIBHAR_COLOR, shape: 'circle', url: '' },
        { x: 91, y: 89, label: 'MK',        color: TIBHAR_COLOR, shape: 'circle', url: '' },
        { x: 91, y: 86, label: 'MK FX',     color: TIBHAR_COLOR, shape: 'circle', url: '' },
        { x: 95, y: 93, label: 'MK Pro',    color: TIBHAR_COLOR, shape: 'circle', url: '' },
        { x: 92, y: 90, label: 'MX-K',      color: TIBHAR_COLOR, shape: 'rect',   url: '' },
        { x: 95, y: 91, label: 'MX-K H',    color: TIBHAR_COLOR, shape: 'rect',   url: '' },
    ];

    // --- 2. Chart Setup ---
    const ctx = document.getElementById('rubberChart').getContext('2d');

    // Legend icons
    const butterflyLegendIcon = new Image();
    butterflyLegendIcon.src = BUTTERFLY_ICON;
    const tibharLegendIcon = new Image();
    tibharLegendIcon.src = TIBHAR_ICON;

    // Keep a stable reference so the legend can re-enable the dataset if needed.
    const butterflyDataset = {
        label: BUTTERFLY, // Single Category Name
        data: butterflyRubbers,
        // Map the styles from the data array
        pointBackgroundColor: butterflyRubbers.map(d => d.color),
        pointStyle: butterflyRubbers.map(d => d.shape),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const tibharDataset = {
        label: TIBHAR,
        data: tibharRubbers,
        pointBackgroundColor: tibharRubbers.map(d => d.color ?? TIBHAR_COLOR),
        pointStyle: tibharRubbers.map(d => d.shape ?? 'circle'),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                butterflyDataset,
                tibharDataset
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: { top: 20, right: 50, bottom: 20, left: 20 }
            },
            scales: {
                x: {
                    min: 40,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Spin',
                        font: { size: 16, weight: 'normal' },
                        color: '#000'
                    },
                    grid: {
                        color: 'white',
                        lineWidth: 2
                    }
                },
                y: {
                    min: 40,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Speed',
                        font: { size: 16, weight: 'normal' },
                        color: '#000'
                    },
                    grid: {
                        color: 'white',
                        lineWidth: 2
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { 
                        usePointStyle: true, 
                        boxWidth: 18,
                        // Make only "Butterfly" bold; keep all other chart text non-bold.
                        font: (context) => {
                            const item = context?.chart?.legend?.legendItems?.[context.index];
                            const text = (item?.text ?? '').replace(/\u00A0/g, '').trim();
                            return { size: 12, weight: text === BUTTERFLY ? 'bold' : 'normal' };
                        },
                        // Force the legend icon to look generic (e.g., a circle) 
                        // or pick a specific color since the dataset has multiple colors.
                        generateLabels: function(chart) {
                            const datasets = chart.data.datasets ?? [];
                            return datasets.map((ds, datasetIndex) => {
                                const label = ds.label ?? '';
                                const isVisible = chart.isDatasetVisible(datasetIndex);

                                const brandColor =
                                    label === BUTTERFLY ? BUTTERFLY_COLOR :
                                    label === TIBHAR ? TIBHAR_COLOR :
                                    '#000';

                                const icon =
                                    label === BUTTERFLY ? butterflyLegendIcon :
                                    label === TIBHAR ? tibharLegendIcon :
                                    null;

                                const pointStyle =
                                    (icon && icon.complete && icon.naturalWidth > 0)
                                        ? icon
                                        : 'circle';

                                const legendColor = isVisible ? brandColor : '#9e9e9e';

                                return {
                                    // Add a little visual gap between the icon and the label text
                                    text: `\u00A0\u00A0${label}`,
                                    fillStyle: legendColor,
                                    strokeStyle: legendColor,
                                    fontColor: legendColor,
                                    pointStyle,
                                    hidden: false,
                                    datasetIndex
                                };
                            });
                        }
                    },
                    // Clicking the legend item toggles the dataset on/off.
                    onClick: function(_e, legendItem, legend) {
                        const chart = legend.chart;
                        const idx = legendItem.datasetIndex;
                        chart.setDatasetVisibility(idx, !chart.isDatasetVisible(idx));
                        chart.update();
                    },
                },
                tooltip: {
                    enabled: true,
                    titleFont: { weight: 'normal' },
                    bodyFont: { weight: 'normal' },
                    callbacks: {
                        label: function(context) {
                            return `${context.raw.label} (Spin: ${context.raw.x}, Speed: ${context.raw.y})`;
                        }
                    }
                },
                datalabels: {
                    align: function(context) {
                        const val = context.dataset.data[context.dataIndex];
                        return val.x > 80 ? 'left' : 'right';
                    },
                    anchor: 'center',
                    offset: 10,
                    color: '#000',
                    font: { size: 11, weight: 'normal' },
                    formatter: function(value) {
                        return value.label;
                    }
                }
            },
            // --- 3. Click Event Handler ---
            onClick: (evt, activeElements, chart) => {
                if (activeElements.length > 0) {
                    const datasetIndex = activeElements[0].datasetIndex;
                    const dataIndex = activeElements[0].index;
                    const pointData = chart.data.datasets[datasetIndex].data[dataIndex];

                    // Prefer per-rubber manual link if provided.
                    const manualUrl = typeof pointData.url === 'string' ? pointData.url.trim() : '';
                    if (manualUrl) {
                        window.open(manualUrl, '_blank');
                        return;
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Once the icon loads, redraw so the legend swaps from fallback circle to the icon.
    butterflyLegendIcon.addEventListener('load', () => chart.update());
    butterflyLegendIcon.addEventListener('error', () => {
        console.warn('Failed to load legend icon:', butterflyLegendIcon.src);
    });
    tibharLegendIcon.addEventListener('load', () => chart.update());
    tibharLegendIcon.addEventListener('error', () => {
        console.warn('Failed to load legend icon:', tibharLegendIcon.src);
    });
</script>

</body>
</html> 