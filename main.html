<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pingpong Rubber Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            color-scheme: dark;
            --bg0: #060914;
            --bg1: #0b1022;
            --panel: rgba(255, 255, 255, 0.06);
            --panel-2: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.14);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.70);
            --shadow: rgba(0, 0, 0, 0.55);
            --focus: rgba(95, 207, 255, 0.55);
            --link: #7cd3ff;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
                "Segoe UI Emoji";
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: var(--text);
            background:
                radial-gradient(900px 500px at 18% 18%, rgba(233, 65, 145, 0.16), transparent 60%),
                radial-gradient(900px 500px at 82% 24%, rgba(211, 47, 47, 0.14), transparent 60%),
                radial-gradient(900px 500px at 55% 85%, rgba(124, 211, 255, 0.10), transparent 60%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
        }
        .chart-container {
            position: relative;
            height: 80vh;
            width: 80vw;
            background:
                linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            box-shadow:
                0 24px 70px var(--shadow),
                inset 0 1px 0 rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }
        .tabs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .tab {
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            border-radius: 999px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            user-select: none;
            transition: background-color 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
        }
        .tab:hover {
            background: rgba(255, 255, 255, 0.10);
            border-color: rgba(255, 255, 255, 0.22);
        }
        .tab:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus);
        }
        .tab.active {
            background: rgba(255, 255, 255, 0.14);
            border-color: rgba(255, 255, 255, 0.26);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        .tab img {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }
        .lang-switch {
            position: fixed;
            top: 14px;
            right: 14px;
            z-index: 20;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(10, 14, 28, 0.55);
            box-shadow: 0 14px 35px rgba(0,0,0,0.45);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .lang-switch label {
            font-size: 12px;
            font-weight: 700;
            color: rgba(255,255,255,0.80);
        }
        .lang-switch select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.92);
            border-radius: 999px;
            padding: 6px 34px 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            line-height: 1.2;
        }
        .lang-switch select:hover {
            background: rgba(255, 255, 255, 0.10);
            border-color: rgba(255, 255, 255, 0.22);
        }
        .lang-switch select:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus);
        }
        .lang-switch .select-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .lang-switch .select-wrap::after {
            content: 'â–¾';
            position: absolute;
            right: 12px;
            pointer-events: none;
            color: rgba(255,255,255,0.70);
            font-size: 12px;
            transform: translateY(-0.5px);
        }
        .lang-switch option {
            color: #111; /* native select dropdown text color (platform-dependent) */
        }
        .canvas-wrap {
            position: relative;
            flex: 1;
            /* Important for flexbox: allow the chart area to shrink instead of overflowing
               (otherwise the bottom axis can get clipped when the container has overflow:hidden). */
            min-height: 0;
        }
        #rubberChart {
            display: block;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 14px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
        }
        .shape-legend {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: rgba(10, 14, 28, 0.72);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 12px;
            line-height: 1.25;
            color: var(--text);
            box-shadow: 0 14px 35px rgba(0,0,0,0.45);
            pointer-events: none; /* don't block chart hover/click */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .shape-legend .row {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .shape-legend .row + .row {
            margin-top: 6px;
        }
        .shape-legend .marker {
            display: inline-block;
            width: 12px;
            height: 12px;
            flex: 0 0 12px;
        }
        .shape-legend .marker.rect {
            background: #FF9100;
            border-radius: 2px;
        }
        .shape-legend .marker.circle {
            background: #FF9100;
            border-radius: 999px;
        }
        .hardness-legend {
            position: absolute;
            left: 12px;
            /* Keep it compact so it doesn't cover the chart area. */
            right: auto;
            width: fit-content; /* shrink-wrap contents */
            max-width: min(280px, calc(100% - 260px));
            bottom: 12px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 4px;
            padding: 6px 8px;
            background: rgba(10, 14, 28, 0.42);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
            pointer-events: none; /* don't block chart hover/click */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            --edgeGap: 10px;
            /* Controls the overall width of the hardness legend. */
            --barW: clamp(96px, 16vw, 160px);
            /* Keep the bar aligned with the example number column (which has a flag column). */
            --countryW: 26px;
            --countryGap: 10px;
        }
        .hardness-legend .title {
            font-size: 12px;
            line-height: 1;
            font-weight: 700;
            color: rgba(255,255,255,0.88);
            letter-spacing: 0.2px;
        }
        .hardness-legend .content {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 4px;
        }
        .hardness-legend .row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Offset the bar by the same space used by the example's flag column + gap. */
            padding-left: calc(var(--countryW) + var(--countryGap));
        }
        .hardness-legend .label {
            font-size: 12px;
            line-height: 1;
            color: rgba(255,255,255,0.78);
            white-space: nowrap;
            letter-spacing: 0.2px;
        }
        .hardness-legend .label.soft {
            text-align: right;
        }
        .hardness-legend .label.hard {
            text-align: left;
        }
        .hardness-legend .bar {
            height: 18px;
            /* Narrower bar width (horizontal) while staying responsive. */
            flex: 0 0 var(--barW);
            border-radius: 999px;
            background: linear-gradient(
                90deg,
                #FFE0B2 0%,
                #FFCC80 25%,
                #FFB74D 50%,
                #FF9100 75%,
                #EF6C00 100%
            );
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.16);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 0.3px;
            color: rgba(255,255,255,0.92);
            text-shadow: 0 1px 2px rgba(0,0,0,0.45);
        }
        .hardness-legend .example {
            font-size: 11px;
            line-height: 1.15;
            color: rgba(255,255,255,0.72);
            font-variant-numeric: tabular-nums;
            /* Align examples under the bar (not under the edge labels). */
            padding-left: 0;
            padding-right: 0;
        }
        .hardness-legend .example .ex-line {
            display: flex;
            align-items: center;
            gap: var(--countryGap);
            justify-content: flex-start;
        }
        .hardness-legend .example .ex-line + .ex-line {
            margin-top: 4px;
        }
        .hardness-legend .example .country {
            width: var(--countryW);
            color: rgba(255,255,255,0.82);
            white-space: nowrap;
        }
        .hardness-legend .example .country.flag {
            font-size: 16px;
            line-height: 1;
            font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui;
            transform: translateY(1px);
        }
        .hardness-legend .example .nums {
            position: relative;
            flex: 0 0 var(--barW);
            width: var(--barW);
            height: 12px;
        }
        .hardness-legend .example .n {
            position: absolute;
            top: 0;
            white-space: nowrap;
        }
        .hardness-legend .example .n.left {
            left: 0;
            transform: translateX(0);
        }
        .hardness-legend .example .n.mid {
            left: 50%;
            transform: translateX(-50%);
        }
        .hardness-legend .example .n.right {
            left: 100%;
            transform: translateX(-100%);
        }
        .chart-tooltip {
            position: absolute;
            z-index: 5;
            max-width: 320px;
            background: rgba(10, 14, 28, 0.90);
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text);
            font-size: 12px;
            line-height: 1.3;
            box-shadow: 0 18px 45px rgba(0,0,0,0.55);
            pointer-events: auto; /* allow clicking links */
            display: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .chart-tooltip .t {
            font-weight: 700;
            margin-bottom: 6px;
        }
        .chart-tooltip .row + .row {
            margin-top: 4px;
        }
        .chart-tooltip .links {
            margin-top: 8px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .chart-tooltip a {
            color: var(--link);
            text-decoration: none;
        }
        .chart-tooltip a:hover {
            text-decoration: underline;
        }
        .chart-tooltip .icon-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        .chart-tooltip .icon-link img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            display: block;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.55));
        }
    </style>
</head>
<body>

<div class="lang-switch" aria-label="Language">
    <span class="select-wrap">
        <select id="langSelect" aria-label="Language">
            <option value="ko">ðŸ‡°ðŸ‡· Korea</option>
            <option value="en">ðŸ‡ºðŸ‡¸ USA</option>
        </select>
    </span>
</div>

<div class="chart-container">
    <div class="tabs" role="tablist" aria-label="Brand" id="brandTabs">
        <button class="tab active" type="button" role="tab" aria-selected="true" data-brand="Butterfly">
            <img src="images/butterfly.ico" alt="" aria-hidden="true" />
            <span data-i18n="brandButterfly">Butterfly</span>
        </button>
        <button class="tab" type="button" role="tab" aria-selected="false" data-brand="Tibhar">
            <img src="images/tibhar.png" alt="" aria-hidden="true" />
            <span data-i18n="brandTibhar">Tibhar</span>
        </button>
    </div>
    <div class="canvas-wrap">
        <canvas id="rubberChart"></canvas>
        <div class="hardness-legend" aria-hidden="true">
            <div class="content">
                <div class="row">
                    <span class="bar" data-i18n="legendHardness">Hardness</span>
                </div>
                <div class="example">
                    <div class="ex-line">
                        <span class="country flag" title="Germany">ðŸ‡©ðŸ‡ª</span>
                        <div class="nums">
                            <span class="n left">40</span>
                            <span class="n mid">47.5</span>
                            <span class="n right">55</span>
                        </div>
                    </div>
                    <div class="ex-line">
                        <span class="country flag" title="Japan">ðŸ‡¯ðŸ‡µ</span>
                        <div class="nums">
                            <span class="n left">33</span>
                            <span class="n mid">36</span>
                            <span class="n right">44</span>
                        </div>
                    </div>
                    <div class="ex-line">
                        <span class="country flag" title="China">ðŸ‡¨ðŸ‡³</span>
                        <div class="nums">
                            <span class="n left">35</span>
                            <span class="n mid">39</span>
                            <span class="n right">41</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="shape-legend" aria-hidden="true">
            <div class="row">
                <span class="marker rect"></span>
                <span data-i18n="legendPimplesIn">Pimples-in</span>
            </div>
            <div class="row">
                <span class="marker circle"></span>
                <span data-i18n="legendHybrid">Hybrid</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- i18n (EN/KR) ---
    const I18N = {
        en: {
            pageTitle: 'Pingpong Rubber Chart',
            ariaBrandTabs: 'Brand',
            brandButterfly: 'Butterfly',
            brandTibhar: 'Tibhar',
            legendHardness: 'Hardness',
            legendPimplesIn: 'Pimples-in',
            legendHybrid: 'Hybrid',
            axisSpin: 'Spin',
            axisSpeed: 'Speed',
            tooltipSpinSpeed: 'Spin: {spin}, Speed: {speed}',
            tooltipType: 'Type',
            tooltipArc: 'Arc',
            tooltipThickness: 'Thickness',
            tooltipSheetColors: 'Sheet colors',
            tooltipStrategy: 'Strategy',
            tooltipControl: 'Control',
            tooltipWeight: 'Weight',
            tooltipHardness: 'Hardness',
            tooltipPlayer: 'Player',
            iconSale: 'Sale',
            iconYouTube: 'YouTube'
        },
        ko: {
            pageTitle: 'íƒêµ¬ ëŸ¬ë²„ ì°¨íŠ¸',
            ariaBrandTabs: 'ë¸Œëžœë“œ',
            brandButterfly: 'ë²„í„°í”Œë¼ì´',
            brandTibhar: 'í‹°ë°”',
            legendHardness: 'ê²½ë„',
            legendPimplesIn: 'í‰ë©´ëŸ¬ë²„',
            legendHybrid: 'í•˜ì´ë¸Œë¦¬ë“œ',
            axisSpin: 'íšŒì „',
            axisSpeed: 'ìŠ¤í”¼ë“œ',
            tooltipSpinSpeed: 'íšŒì „: {spin}, ìŠ¤í”¼ë“œ: {speed}',
            tooltipType: 'íƒ€ìž…',
            tooltipArc: 'ì•„í¬',
            tooltipThickness: 'ë‘ê»˜',
            tooltipSheetColors: 'ì‹œíŠ¸ ìƒ‰ìƒ',
            tooltipStrategy: 'ìŠ¤íƒ€ì¼',
            tooltipControl: 'ì»¨íŠ¸ë¡¤',
            tooltipWeight: 'ë¬´ê²Œ',
            tooltipHardness: 'ê²½ë„',
            tooltipPlayer: 'ì„ ìˆ˜',
            iconSale: 'êµ¬ë§¤',
            iconYouTube: 'ìœ íŠœë¸Œ'
        }
    };

    function detectDefaultLang() {
        const nav = (navigator.language || '').toLowerCase();
        return nav.startsWith('ko') ? 'ko' : 'en';
    }

    let currentLang = window.localStorage.getItem('lang') || detectDefaultLang();
    if (!I18N[currentLang]) currentLang = 'en';

    function t(key, vars) {
        const table = I18N[currentLang] || I18N.en;
        let s = table[key] ?? I18N.en[key] ?? key;
        if (vars && typeof s === 'string') {
            for (const [k, v] of Object.entries(vars)) {
                s = s.replaceAll(`{${k}}`, String(v));
            }
        }
        return s;
    }

    function localizeBrandName(brand) {
        if (brand === 'Butterfly') return t('brandButterfly');
        if (brand === 'Tibhar') return t('brandTibhar');
        return brand;
    }

    // Rubber name localization (used by point labels + tooltip title)
    const RUBBER_NAME_KO = {
        'Dignics 05': 'ë””ê·¸ë‹‰ìŠ¤ 05',
        'Dignics 09C': 'ë””ê·¸ë‹‰ìŠ¤ 09C',
        'Dignics 64': 'ë””ê·¸ë‹‰ìŠ¤ 64',
        'Dignics 80': 'ë””ê·¸ë‹‰ìŠ¤ 80',
        'Glayzer': 'ê¸€ë ˆì´ì €',
        'Glayzer 09C': 'ê¸€ë ˆì´ì € 09C',
        'Rozena': 'ë¡œì œë‚˜',
        'Tenergy 05': 'í…Œë„ˆì§€ 05',
        'Tenergy 05 Hard': 'í…Œë„ˆì§€ 05í•˜ë“œ',
        'Tenergy 05 FX': 'í…Œë„ˆì§€ 05FX',
        'Tenergy 19': 'í…Œë„ˆì§€ 19',
        'Tenergy 25': 'í…Œë„ˆì§€ 25',
        'Tenergy 25 FX': 'í…Œë„ˆì§€ 25FX',
        'Tenergy 64': 'í…Œë„ˆì§€ 64',
        'Tenergy 64 FX': 'í…Œë„ˆì§€ 64FX',
        'Tenergy 80': 'í…Œë„ˆì§€ 80',
        'Tenergy 80 FX': 'í…Œë„ˆì§€ 80FX',
        'Zyre 03': 'ìžì´ì–´ 03',

        // Tibhar (Evolution / Hybrid)
        'EL-D': 'EL-D',
        'EL-P': 'EL-P',
        'EL-S': 'EL-S',
        'FX-D': 'FX-D',
        'FX-P': 'FX-P',
        'FX-S': 'FX-S',
        'MX-D': 'MX-D',
        'MX-P': 'MX-P',
        'MX-P 50': 'MX-P 50',
        'MX-S': 'MX-S',
        'K3': 'K3',
        'K3 FX': 'K3 FX',
        'K3 Pro': 'K3 Pro',
        'MK': 'MK',
        'MK FX': 'MK FX',
        'MK Pro': 'MK Pro',
    };

    function localizeRubberName(name) {
        const s = typeof name === 'string' ? name : '';
        if (!s) return '';
        if (currentLang !== 'ko') return s;
        return RUBBER_NAME_KO[s] ?? s;
    }

    function applyLanguageToDom() {
        document.documentElement.lang = currentLang;
        document.title = t('pageTitle');

        const brandTabs = document.getElementById('brandTabs');
        if (brandTabs) brandTabs.setAttribute('aria-label', t('ariaBrandTabs'));

        document.querySelectorAll('[data-i18n]').forEach((el) => {
            const key = el.getAttribute('data-i18n');
            if (!key) return;
            el.textContent = t(key);
        });
        const select = document.getElementById('langSelect');
        if (select && select.value !== currentLang) select.value = currentLang;
    }

    function applyLanguageToChart(chart) {
        if (!chart?.options?.scales) return;
        if (chart.options.scales.x?.title) chart.options.scales.x.title.text = t('axisSpin');
        if (chart.options.scales.y?.title) chart.options.scales.y.title.text = t('axisSpeed');
        chart.update();
    }

    function setLang(lang, chart, tooltipEl) {
        if (!I18N[lang]) return;
        currentLang = lang;
        window.localStorage.setItem('lang', currentLang);
        applyLanguageToDom();
        applyLanguageToChart(chart);
        if (tooltipEl) tooltipEl.style.display = 'none';
    }

    // --- 1. Consolidated Data ---
    // We store color and shape directly with the data point to keep the visual distinction
    // while using only one dataset.

    // Brand-specific knobs (easy to replace later)
    const BUTTERFLY = 'Butterfly';
    const BUTTERFLY_ICON = 'images/butterfly.ico';

    const TIBHAR = 'Tibhar';
    const TIBHAR_ICON = 'images/tibhar.png';

    // Axis ranges per brand (used by the tabs).
    // Tune these numbers if you want a tighter/looser zoom per brand.
    const BRAND_AXIS_RANGES = {
        // Butterfly includes everything from classic control rubbers to modern high-tension.
        [BUTTERFLY]: { xMin: 55,  xMax: 105, yMin: 60,  yMax: 95 },
        [TIBHAR]:    { xMin: 110, xMax: 135, yMin: 110, yMax: 135 },
    };

    // Normal Rubber (Orange) - shade by hardness (higher hardness => darker)
    const NORMAL_RUBBER_ULTRA_LIGHT = '#FFE0B2'; // Very light orange / pastel
    const NORMAL_RUBBER_VERY_LIGHT  = '#FFCC80'; // Lighter than LIGHT
    const NORMAL_RUBBER_LIGHT       = '#FFB74D'; // Light
    const NORMAL_RUBBER_COLOR       = '#FF9100'; // Normal
    const NORMAL_RUBBER_DARK        = '#EF6C00'; // Dark

    const NORMAL_RUBBER_SHADES = [
        NORMAL_RUBBER_ULTRA_LIGHT,
        NORMAL_RUBBER_VERY_LIGHT,
        NORMAL_RUBBER_LIGHT,
        NORMAL_RUBBER_COLOR,
        NORMAL_RUBBER_DARK
    ];

    // Company-specific hardness ranges (tweak these as you add more brands).
    // If a brand is missing here, we fall back to min/max computed from the brand's dataset.
    const BRAND_HARDNESS_RANGES = {
        [BUTTERFLY]: { min: 32, max: 44 },  // Butterfly typically shows ~32..44 in this chart
        [TIBHAR]:    { min: 40, max: 55 },  // Tibhar typically shows ~40..55 in this chart
    };

    function parseHardness(h) {
        if (typeof h === 'number' && Number.isFinite(h)) return h;
        if (typeof h === 'string') {
            const n = Number.parseFloat(h.trim());
            return Number.isFinite(n) ? n : null;
        }
        return null;
    }

    function computeHardnessRange(data) {
        let min = Infinity;
        let max = -Infinity;
        for (const d of data) {
            const h = parseHardness(d?.hardness);
            if (h == null) continue;
            if (h < min) min = h;
            if (h > max) max = h;
        }
        if (!Number.isFinite(min) || !Number.isFinite(max)) return null;
        return { min, max };
    }

    function clamp01(t) {
        if (t < 0) return 0;
        if (t > 1) return 1;
        return t;
    }

    function shadeFromHardness(h, range) {
        if (h == null || !range) return NORMAL_RUBBER_COLOR;
        const denom = (range.max - range.min);
        const t = denom === 0 ? 0.5 : clamp01((h - range.min) / denom);
        const idx = Math.round(t * (NORMAL_RUBBER_SHADES.length - 1));
        return NORMAL_RUBBER_SHADES[idx] ?? NORMAL_RUBBER_COLOR;
    }

    function colorForRubberPoint(d, brand, brandData) {
        const h = parseHardness(d?.hardness);
        const range = BRAND_HARDNESS_RANGES[brand] ?? computeHardnessRange(brandData);
        return shadeFromHardness(h, range);
    }
    function normalizeUrl(u) {
        return typeof u === 'string' ? u.trim() : '';
    }
    
    // Each rubber can optionally include more info (fill what you know):
    // {
    //   x, y, label, shape,
    //   thickness: '1.9 / 2.1',
    //   strategy: 'OFF / OFF+',
    //   control: 85,
    //   weight: '45g',
    //   hardness: '47.5',
    //   player: 'Zhang Jike',
    //   youtubeUrl: 'https://www.youtube.com/watch?v=...',
    //   productUrl: 'https://...',
    //   // Back-compat: `url` is treated as productUrl
    // }
    const butterflyRubbers = [
        // Orange Squares (Tenergy)
        {
            x: 85,
            y: 86,
            label: 'Dignics 05',
            shape: 'rect',
            url: '',
            arc: 88,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 96,
            y: 79,
            label: 'Dignics 09C',
            shape: 'circle',
            url: '',
            arc: 96,
            hardness: '44',
            thickness: '2.1 / 1.9',
        },
        {
            x: 79,
            y: 90,
            label: 'Dignics 64',
            shape: 'rect',
            url: '',
            arc: 84,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 82,
            y: 88,
            label: 'Dignics 80',
            shape: 'rect',
            url: '',
            arc: 86,
            hardness: '40',
            thickness: '2.1 / 1.9',
        },
        {
            x: 73,
            y: 81,
            label: 'Glayzer',
            shape: 'rect',
            url: '',
            arc: 82,
            hardness: '38',
            thickness: '2.1 / 1.9',
        },
        {
            x: 87,
            y: 75,
            label: 'Glayzer 09C',
            shape: 'circle',
            url: '',
            arc: 95,
            hardness: '42',
            thickness: '2.1 / 1.9',
        },
        {
            x: 70,
            y: 83,
            label: 'Rozena',
            shape: 'rect',
            url: '',
            arc: 75,
            hardness: '35',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 76,
            y: 83,
            label: 'Tenergy 05',
            shape: 'rect',
            url: 'https://www.coupang.com/vp/products/8414405864?itemId=24331707549&vendorItemId=92706240298&q=%ED%85%8C%EB%84%88%EC%A7%8005&searchId=d10be3d818557427&sourceType=search&itemsCount=36&searchRank=0&rank=0&traceId=mjxipwjc',
            arc: 79,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 96,
            y: 82,
            label: 'Tenergy 05 Hard',
            shape: 'rect',
            url: '',
            arc: 92,
            hardness: '43',
            thickness: '2.1 / 1.9',
        },
        {
            x: 64,
            y: 81,
            label: 'Tenergy 05 FX',
            shape: 'rect',
            url: '',
            arc: 65,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 75,
            y: 84,
            label: 'Tenergy 19',
            shape: 'rect',
            url: '',
            arc: 78,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 76,
            y: 64,
            label: 'Tenergy 25',
            shape: 'rect',
            url: '',
            arc: 86,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 64,
            y: 62,
            label: 'Tenergy 25 FX',
            shape: 'rect',
            url: '',
            arc: 72,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 70,
            y: 87,
            label: 'Tenergy 64',
            shape: 'rect',
            url: '',
            arc: 75,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 58,
            y: 85,
            label: 'Tenergy 64 FX',
            shape: 'rect',
            url: '',
            arc: 61,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 73,
            y: 85,
            label: 'Tenergy 80',
            shape: 'rect',
            url: '',
            arc: 77,
            hardness: '36',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 61,
            y: 83,
            label: 'Tenergy 80 FX',
            shape: 'rect',
            url: '',
            arc: 63,
            hardness: '32',
            thickness: '2.1 / 1.9 / 1.7',
        },
        {
            x: 100,
            y: 88,
            label: 'Zyre 03',
            shape: 'rect',
            url: '',
            arc: 96,
            hardness: '44',
            thickness: '2.7 / 2.5',
        },
    ];

    // Add Tibhar rubbers here (same format as Butterfly).
    // Example:
    const tibharRubbers = [
        // NOTE: input format provided as "Speed (y) then Spin (x)"
        {
            x: 120,
            y: 125,
            label: 'EL-D',
            shape: 'rect',
            url: '',
            thickness: '1.9 / 2.1',
            strategy: 'OFF- / OFF+',
            control: 83,
            hardness: '45',
        },
        {
            x: 117,
            y: 121,
            label: 'EL-P',
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF+',
            control: 83,
            hardness: '42.5',
        },
        {
            x: 120,
            y: 123,
            label: 'EL-S',
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1,7 / 1,9 / 2,1',
            strategy: 'OFF- / OFF+',
            control: 85,
            hardness: '45',
        },
        {
            x: 118,
            y: 120,
            label: 'FX-D',
            shape: 'rect',
            url: '',
            thickness: '1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 87,
            hardness: '45',
        },
        {
            x: 115,
            y: 120,
            label: 'FX-P',
            shape: 'rect',
            url: '',
            thickness: '1.7 / 1.9 / 2.1',
            strategy: 'ALL / OFF',
            control: 90,
            hardness: '40',
        },
        {
            x: 117,
            y: 118,
            label: 'FX-S',
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 87,
            hardness: '42.5',
        },
        {
            x: 122,
            y: 130,
            label: 'MX-D',
            shape: 'rect',
            url: '',
            youtubeUrl: 'https://www.youtube.com/watch?v=haxt_8BOEoo',
            thickness: '1,9 / 2,1',
            strategy: 'OFF / OFF+',
            control: 75,
            hardness: '52',
        },
        {
            x: 122,
            y: 125,
            label: 'MX-P',
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'OFF- / OFF+',
            control: 80,
            hardness: '47.5',
        },
        {
            x: 120,
            y: 128,
            label: 'MX-P 50',
            shape: 'rect',
            url: '',
            thickness: '2.1',
            strategy: 'OFF / OFF+',
            control: 75,
            hardness: '50',
        },
        {
            x: 124,
            y: 125,
            label: 'MX-S',
            shape: 'rect',
            url: '',
            thickness: '1.5 / 1.7 / 1.9 / 2.1',
            strategy: 'ALL+ / OFF',
            control: 80,
            hardness: '47.5',
        },
        {
            x: 130,
            y: 118,
            label: 'K3',
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 100,
            hardness: '53',
        },
        {
            x: 130,
            y: 115,
            label: 'K3 FX',
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF',
            control: 105,
            hardness: '48',
        },
        {
            x: 130,
            y: 125,
            label: 'K3 Pro',
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 95,
            hardness: '55',
        },
        {
            x: 120,
            y: 124,
            label: 'MK',
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF',
            control: 96,
            hardness: '48',
        },
        {
            x: 118,
            y: 118,
            label: 'MK FX',
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF-',
            control: 104,
            hardness: '44',
        },
        {
            x: 124,
            y: 130,
            label: 'MK Pro',
            shape: 'circle',
            url: '',
            thickness: '2.0 / MAX',
            strategy: 'OFF+',
            control: 90,
            hardness: '51',
        },
    ];

    // --- 2. Chart Setup ---
    const ctx = document.getElementById('rubberChart').getContext('2d');

    const butterflyDataset = {
        label: BUTTERFLY, // Single Category Name
        data: butterflyRubbers,
        // Map the styles from the data array
        pointBackgroundColor: butterflyRubbers.map(d => colorForRubberPoint(d, BUTTERFLY, butterflyRubbers)),
        pointBorderColor: butterflyRubbers.map(d => colorForRubberPoint(d, BUTTERFLY, butterflyRubbers)),
        pointStyle: butterflyRubbers.map(d => d.shape),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const tibharDataset = {
        label: TIBHAR,
        data: tibharRubbers,
        pointBackgroundColor: tibharRubbers.map(d => colorForRubberPoint(d, TIBHAR, tibharRubbers)),
        pointBorderColor: tibharRubbers.map(d => colorForRubberPoint(d, TIBHAR, tibharRubbers)),
        pointStyle: tibharRubbers.map(d => d.shape ?? 'circle'),
        pointRadius: 7,
        pointHoverRadius: 9
    };

    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                butterflyDataset,
                tibharDataset
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                // Extra bottom padding prevents the x-axis title from getting clipped.
                padding: { top: 20, right: 110, bottom: 56, left: 20 }
            },
            scales: {
                x: {
                    display: true,
                    min: 40,
                    max: 100,
                    ticks: {
                        display: true,
                        color: 'rgba(255,255,255,0.55)',
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: t('axisSpin'),
                        font: { size: 16, weight: 'normal' },
                        color: 'rgba(255,255,255,0.88)',
                        padding: { top: 10 }
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.10)',
                        lineWidth: 1
                    }
                },
                y: {
                    display: true,
                    min: 40,
                    max: 100,
                    ticks: {
                        display: true,
                        color: 'rgba(255,255,255,0.55)',
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: t('axisSpeed'),
                        font: { size: 16, weight: 'normal' },
                        color: 'rgba(255,255,255,0.88)'
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.10)',
                        lineWidth: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        externalTooltipHandler(context);
                    }
                },
                datalabels: {
                    // Always place the label immediately to the right of the point (dot).
                    align: 'right',
                    anchor: 'center',
                    offset: 8,
                    color: 'rgba(255,255,255,0.88)',
                    font: { size: 11, weight: 'normal' },
                    textAlign: 'left',
                    clamp: true,
                    formatter: function(value) {
                        return localizeRubberName(value.label);
                    }
                }
            },
            // --- 3. Click Event Handler ---
            onClick: (evt, activeElements, chart) => {
                if (activeElements.length > 0) {
                    const datasetIndex = activeElements[0].datasetIndex;
                    const dataIndex = activeElements[0].index;
                    const ds = chart.data.datasets[datasetIndex];
                    const pointData = ds.data[dataIndex];

                    // Click opens a link if present (shopping preferred, then YouTube).
                    const product = normalizeUrl(pointData.productUrl) || normalizeUrl(pointData.url);
                    const youtube = normalizeUrl(pointData.youtubeUrl);
                    const toOpen = product || youtube;
                    if (toOpen) window.open(toOpen, '_blank');
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // --- HTML tooltip (clickable links) ---
    const canvasWrapEl = document.querySelector('.canvas-wrap');
    const tooltipEl = document.createElement('div');
    tooltipEl.className = 'chart-tooltip';
    canvasWrapEl.appendChild(tooltipEl);

    let tooltipPinned = false;
    let hideTooltipTimer = null;
    tooltipEl.addEventListener('mouseenter', () => {
        tooltipPinned = true;
        if (hideTooltipTimer) {
            window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = null;
        }
    });
    tooltipEl.addEventListener('mouseleave', () => {
        tooltipPinned = false;
        if (hideTooltipTimer) window.clearTimeout(hideTooltipTimer);
        hideTooltipTimer = window.setTimeout(() => {
            tooltipEl.style.display = 'none';
        }, 50);
    });

    function clearEl(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
    }

    function makeLink(label, url) {
        const u = normalizeUrl(url);
        if (!u) return null;
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = label;
        return a;
    }

    function makeIconLink(iconSrc, altText, url) {
        const u = normalizeUrl(url);
        if (!u) return null;
        const a = document.createElement('a');
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'icon-link';
        a.setAttribute('aria-label', altText);
        const img = document.createElement('img');
        img.src = iconSrc;
        img.alt = altText;
        a.appendChild(img);
        return a;
    }

    function externalTooltipHandler(context) {
        const { chart, tooltip } = context;

        // If the tooltip should be hidden, only hide if the user isn't hovering the tooltip itself.
        if (tooltip.opacity === 0) {
            if (tooltipPinned) return;

            // Give the user a small window to move from the point to the tooltip to click links.
            if (hideTooltipTimer) window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = window.setTimeout(() => {
                if (!tooltipPinned) tooltipEl.style.display = 'none';
            }, 350);
            return;
        }

        if (hideTooltipTimer) {
            window.clearTimeout(hideTooltipTimer);
            hideTooltipTimer = null;
        }

        // Populate content from the hovered point.
        const dp = tooltip?.dataPoints?.[0];
        const r = dp?.raw ?? {};
        const brandRaw = dp?.dataset?.label || '';
        const brand = brandRaw ? `${localizeBrandName(brandRaw)}: ` : '';

        clearEl(tooltipEl);

        const title = document.createElement('div');
        title.className = 't';
        title.textContent = `${brand}${localizeRubberName(r.label ?? '')}`;
        tooltipEl.appendChild(title);

        const rows = [];
        rows.push(t('tooltipSpinSpeed', { spin: r.x, speed: r.y }));
        if (r.type) rows.push(`${t('tooltipType')}: ${r.type}`);
        if (typeof r.arc === 'number') rows.push(`${t('tooltipArc')}: ${r.arc}`);
        if (r.thickness) rows.push(`${t('tooltipThickness')}: ${r.thickness}`);
        if (Array.isArray(r.sheetColors) && r.sheetColors.length > 0) rows.push(`${t('tooltipSheetColors')}: ${r.sheetColors.join(' / ')}`);
        if (r.strategy) rows.push(`${t('tooltipStrategy')}: ${r.strategy}`);
        if (typeof r.control === 'number') rows.push(`${t('tooltipControl')}: ${r.control}`);
        if (r.weight) rows.push(`${t('tooltipWeight')}: ${r.weight}`);
        if (r.hardness) rows.push(`${t('tooltipHardness')}: ${r.hardness}`);
        if (r.player) rows.push(`${t('tooltipPlayer')}: ${r.player}`);

        rows.forEach((txt) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.textContent = txt;
            tooltipEl.appendChild(row);
        });

        const links = document.createElement('div');
        links.className = 'links';
        const product = normalizeUrl(r.productUrl) || normalizeUrl(r.url);
        const youtube = normalizeUrl(r.youtubeUrl);
        const aShop = makeIconLink('images/sale.png', t('iconSale'), product);
        const aYt = makeIconLink('images/youtube.ico', t('iconYouTube'), youtube);
        if (aShop) links.appendChild(aShop);
        if (aYt) links.appendChild(aYt);
        if (links.childNodes.length > 0) tooltipEl.appendChild(links);

        // Position near the cursor (within canvas-wrap, which is positioned).
        const wrapRect = canvasWrapEl.getBoundingClientRect();
        const left = Math.min(
            tooltip.caretX + 12,
            wrapRect.width - 12
        );
        const top = Math.min(
            tooltip.caretY + 12,
            wrapRect.height - 12
        );
        tooltipEl.style.left = `${left}px`;
        tooltipEl.style.top = `${top}px`;
        tooltipEl.style.display = 'block';
    }

    function setActiveBrand(brand) {
        // Ensure exactly one brand is visible.
        chart.setDatasetVisibility(0, brand === BUTTERFLY);
        chart.setDatasetVisibility(1, brand === TIBHAR);

        // Apply brand-specific axis ranges.
        const r = BRAND_AXIS_RANGES[brand];
        if (r) {
            chart.options.scales.x.min = r.xMin;
            chart.options.scales.x.max = r.xMax;
            chart.options.scales.y.min = r.yMin;
            chart.options.scales.y.max = r.yMax;
        }

        chart.update();

        // Update tab UI.
        const tabs = document.querySelectorAll('.tab[data-brand]');
        tabs.forEach((btn) => {
            const isActive = btn.getAttribute('data-brand') === brand;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
    }

    // Default to Butterfly.
    setActiveBrand(BUTTERFLY);

    // Language switch init + handlers.
    applyLanguageToDom();
    applyLanguageToChart(chart);
    const langSelect = document.getElementById('langSelect');
    if (langSelect) {
        langSelect.addEventListener('change', () => {
            const lang = langSelect.value;
            if (!lang) return;
            setLang(lang, chart, tooltipEl);
        });
    }

    // Tab click handlers.
    document.querySelectorAll('.tab[data-brand]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const brand = btn.getAttribute('data-brand');
            if (brand === BUTTERFLY || brand === TIBHAR) setActiveBrand(brand);
        });
    });

</script>

</body>
</html> 